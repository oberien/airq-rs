<!DOCTYPE html>
<html>
<head>
  <title>airQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="flex.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
</head>
<body>
<div>
  <input id="24h" type="button" value="24h" />
  <input id="48h" type="button" value="48h" />
  <input id="All" type="button" value="All" />
</div>
<div class="flex row wrap">
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="healthPerformance"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="temperatureDewpt"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="tvoc"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="humidity"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="sound"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="pressure"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="o2co2"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="fine-dust"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="o3no2"></canvas></div>
  <div class="flex-100 xs-flex-100 sm-flex-50 md-flex-33 l-flex-33 xl-flex-33 xxl-flex-25"><canvas class="zoom" id="coso2"></canvas></div>
</div>
<div id="overlay" class="overlay hidden">
  <div id="overlay-inner" class="overlay-inner" onclick="event.stopPropagation()">
  </div>
</div>
<script>
const chartConfigs = {};

const overlay = document.getElementById("overlay");
const overlayInner = document.getElementById("overlay-inner");

overlay.onclick = () => {
  overlayInner.innerHTML = "";
  overlay.classList.add("hidden")
}
for (const e of document.getElementsByClassName("zoom")) {
  e.onclick = () => {
    const canvas = document.createElement("canvas");
    overlayInner.appendChild(canvas);
    new Chart(canvas, chartConfigs[e.id]);
    overlay.classList.remove("hidden");
  }
}

document.getElementById("24h").onclick = get24h;
document.getElementById("48h").onclick = get48h;
document.getElementById("All").onclick = getAll;

get24h();

function get(path, callback) {
  const xhr = new XMLHttpRequest();
  xhr.onload = callback;
  xhr.open("GET", path);
  xhr.send();
}
function getData(from, to) {
  get("/data/" + from + "/" + to, gotData);
}
function get24h() {
  const now = Date.now();
  const before = now - 24 * 3600 * 1000;
  getData(before, now);
}
function get48h() {
  const now = Date.now();
  const before = now - 48 * 3600 * 1000;
  getData(before, now);
}
function getAll() {
  get("/timestamps", gotTimestamps);
}
function gotTimestamps() {
  window.timestamps = JSON.parse(this.response);
  getData(timestamps.first, timestamps.last);
}


function makeGraph(obj) {
  const id = obj.id;
  const axes = obj.axes;
  const left = obj.left || [];
  const right = obj.right || [];
  const ctx = document.getElementById(id);

  const rightUsed = axes.some(([l, d, c, axisId]) => axisId === "right");
  const config = {
    type: 'line',
    data: {
      labels: window.data.timestamp,
      datasets: axes.map(([label, data, color, yAxisID]) => {return {
        label: label,
        data: data,
        fill: false,
        pointRadius: 1.5,
        borderColor: color,
        yAxisID: yAxisID,
      }}),
    },
    options: {
      responsive: true,
      tooltips: {
        mode: 'index',
        callbacks: {
          label: function(tooltipItem, data) {
            let label = data.datasets[tooltipItem.datasetIndex].label || '';

            if (label) {
              label += ': ';
            }
            label += tooltipItem.yLabel.toFixed(2);
            return label;
          }
        },
      },
      scales: {
        xAxes: [{
          type: 'time',
          time: {
            unit: 'hour',
            displayFormats: {
              hour: 'MMM D hA',
            },
            parser: "MM/DD/YYYY HH:mm",
            // round: 'day'
            tooltipFormat: 'll HH:mm',
          },
          scaleLabel: {
            display: true,
            labelString: 'Date'
          },
        }],
        yAxes: [{
          id: "left",
          type: 'linear',
          display: true,
          position: "left",
          ticks: {
            min: left[0],
            max: left[1],
          },
        }],
      },
    },
  };
  if (rightUsed) {
    config.options.scales.yAxes.push({
      id: "right",
      type: 'linear',
      display: true,
      position: "right",
      ticks: {
        min: right[0],
        max: right[1],
      },
    });
  }
  new Chart(ctx, config);
  chartConfigs[id] = config;
}

function gotData() {
  window.data = JSON.parse(this.responseText);

  makeGraph({
    id: "healthPerformance",
    axes: [
      ["health", window.data.health, "green"],
      ["performance", window.data.performance, "blue"],
    ],
    left: [0, 1000],
    right: [0, 1000],
  });
  makeGraph({
    id: "temperatureDewpt",
    axes: [
      ["temperature (°C)", window.data.temperature, "red"],
      ["dew point (°C)", window.data.dewpt, "blue"],
    ],
    left: [10, 40],
  });
  makeGraph({
    id: "tvoc",
    axes: [
      ["VOCs (ppb)", window.data.tvoc, "black"],
    ],
    // left: [0, 500],
  });
  makeGraph({
    id: "humidity",
    axes: [
      ["Humidity (%)", window.data.humidity, "deepskyblue", "left"],
      ["Humidity (g/m³)", window.data.humidity_abs, "blue", "right"],
    ]
  });
  makeGraph({
    id: "sound",
    axes: [
      ["Sound (dB(A))", window.data.sound, "red"],
    ],
  });
  makeGraph({
    id: "pressure",
    axes: [
      ["Pressue (hPa)", window.data.pressure, "#368BC1"],
    ],
  });
  makeGraph({
    id: "o2co2",
    axes: [
      ["CO₂ (ppm)", window.data.co2, "darkslateblue", "left"],
      ["O₂ (%)", window.data.oxygen, "lightblue", "right"],
    ],
  });
  makeGraph({
    id: "fine-dust",
    axes: [
      ["PM 1 (μg/m³)", window.data.pm1, "darkgray"],
      ["PM 2.5 (μg/m³)", window.data.pm2_5, "gray"],
      ["PM 10 (μg/m³)", window.data.pm10, "dimgray"],
    ],
  });
  makeGraph({
    id: "o3no2",
    axes: [
      ["O₃ (μg/m³)", window.data.o3, "red", "left"],
      ["NO₂ (μg/m³)", window.data.no2, "coral", "left"],
    ],
  });
  makeGraph({
    id: "coso2",
    axes: [
      ["CO (mg/m³)", window.data.co, "olive", "left"],
      ["SO₂ (μg/m³)", window.data.so2, "gold", "right"],
    ],
    right: [0, 500],
  });
}
</script>
</body>
</html>


